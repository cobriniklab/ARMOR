---
title: "DRIMSeq DTU"
author: ""
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: yeti
    highlight: tango
    code_folding: show
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This script performs differential transcript usage analysis with DRIMSeq, based
on abundance estimates from Salmon. It supports testing one or more contrasts.

# Load packages

```{r}
suppressPackageStartupMessages({
  library(dplyr)
  library(tximport)
  library(tximeta)
  library(SummarizedExperiment)
  library(edgeR)
  library(DRIMSeq)
  library(ggplot2)
})
```

# Load `SummarizedExperiment` object

We will use the transcript-level quantifications.

```{r}
sg <- se$sg
st <- se$st
```

# Create dmDSdata object

```{r}
counts <- data.frame(feature_id = rownames(st),
                     gene_id = unlist(rowData(st)$gene_id),
                     assays(st)[["counts"]],
                     row.names = NULL)

metadata <- metadata %>% select(sample_id = names, group  = celline)
  
d <- dmDSdata(counts = counts, samples = metadata)
plotData(d)
```

# Filter ************** MODIFY ************** 

```{r}
d <- dmFilter(d, min_samps_gene_expr = 3, min_samps_feature_expr = 3,
              min_gene_expr = 10, min_feature_expr = 5)
```

# Define design. ************** MODIFY ************** 

```{r}
# (des <- model.matrix(~ XXXX, data = samples(d)))
(des <- model.matrix(~ 0 + group, data = samples(d)))
```

# Calculate precision

```{r}
set.seed(123)
d <- dmPrecision(d, design = des)
plotPrecision(d)
```

# Fit model

```{r}
d <- dmFit(d, design = des, verbose = 1)
```

# Define contrasts. ************** MODIFY ************** 

```{r}
#(contrasts <- as.data.frame(makeContrasts(XXXX, levels = des)))
(contrasts <- as.data.frame(makeContrasts("groupN61311-groupN052611", levels = des)))
```

# Perform tests ************** MODIFY **************

```{r}
level <- "gene" ## set to "feature" if transcript-level results are desired
signif3 <- function(x) signif(x, digits = 3)
DRIMSeq_fits <- lapply(contrasts, function(cm) {
  dr <- dmTest(d, contrast = cm, verbose = 1)
  print(plotPValues(dr, level = level))
  dr
})

DRIMSeq_res <- lapply(DRIMSeq_fits, function(dr) {
  results(dr, level = level) %>% dplyr::mutate_if(is.numeric, signif3)
})
```

# Write results to text files and save .rds file

```{r}
if (class(DRIMSeq_res) == "data.frame") {
  write.table(DRIMSeq_res %>% dplyr::arrange(pvalue), 
              file = "DRIMSeq_dtu_results.txt", 
              sep = "\t", row.names = FALSE, col.names = TRUE, quote = FALSE)
} else {
  for (nm in names(DRIMSeq_res)) {
    write.table(DRIMSeq_res[[nm]] %>% dplyr::arrange(pvalue), 
                file = paste0("DRIMSeq_dtu_results_", nm, ".txt"), 
                sep = "\t", row.names = FALSE, col.names = TRUE, quote = FALSE)
  }
}

saveRDS(list(results = DRIMSeq_res, fits = DRIMSeq_fits), 
        file = "DRIMSeq_dtu.rds")
```

# Session info

```{r}
date()
sessionInfo()
```

